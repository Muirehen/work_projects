# Яндекс Практикум, Карьерный центр. Сопоставление геоназваний
Рекомендуется смотреть проект через [NBViewer](https://nbviewer.jupyter.org/github/Muirehen/work_projects/blob/master/Yandex_Geonames/Geonames_notebook.ipynb?flush_cache=true).

**Бизнес-задача:** в базе данных Карьерного Центра есть названия географических объектов с разным написанием или ошибками, например:
- СПб
- Санкт-Петербург
- С.-Петербург
- Сант-Питербург
Необходимо их привести к единому виду согласно geonames:
- Saint Petersburg
  
GeoNames - это географическая база данных, которая охватывает все страны и содержит более одиннадцати миллионов географических названий, доступных для бесплатного скачивания. На основе этой базы строятся многие сервисы и плагины проверки и унификации адресов.

**ML-задача:** Необходимо разработать ML-продукт, который:
- подбирает наиболее подходящие названия с geonames. Например Ереван -> Yerevan
- покажет хорошую точность на примере РФ и стран наиболее популярных для релокации - Беларусь, Армения, Казахстан, Кыргызстан, Турция, Сербия. Города с населением от 15000 человек (с возможностью масштабирования на сервере заказчика)
  
**Задачи опционально:**
- возможность настройки количества выдачи подходящих названий (например в параметрах метода);
- коррекция ошибок и опечаток. Например Моченгорск -> Monchegorsk;
- хранение в PostgreSQL данных geonames;
- хранение векторизованных промежуточных данных в PostgreSQL;
- предусмотреть методы для настройки подключения к БД;
- предусмотреть метод для инициализации класса (первичная векторизация geonames);
- предусмотреть методы для добавления векторов новых геоназваний.

**Формат результата:**
- Возвращаемые поля geonameid, name, region, country, cosine similarity
- формат данных на выходе: список словарей, например [{dict_1}, {dict_2}, …. {dict_n}] где словарь - одна запись с указанными полями

## Исходные данные

Ссылка на данные geonames:
http://download.geonames.org/export/dump/

Используемые таблицы с geonames:
- admin1CodesASCII;
- alternateNamesV2;
- cities500;
- countryInfo.

Дополнительно:
- Тестовый датасет.
  
## Описание тетради
**Ход исследовательской работы**

В рамках данной задачи были выполнены следующие этапы:

- проведены исследование и предобработка данных;
- заполнены пропуски;
- выполнена проверка на дубликаты;
- созданы два векторизованных корпуса;
- проведено исследование влияния векторных расстояний на результат.

В качестве MVP был выбран подход с суммарным косинусным расстоянием и расстоянием Минковского.

**Результаты исследовательской работы**

На тестовом датасете получена точность выше 95%. На основе данных, полученных в ходе исследовательских работ, был создан модуль `geonames`, который по запросу пользователя подбирает подходящие названия geonames с высокой точностью. Также модуль позволяет:
- настраивать поключение к БД;
- векторизировать корпуса названий и варьировать списком стран для поиска;
- хранить векторизованные данные в PostgreSQL;
- настраивать количество названий для выдачи.

При этом модуль "терпим" к возможным ошибкам ввода, благодаря комбинации расстояний.

**Рекомендации по улучшению решения**

1. Параметризовать веса расстояний и попробовать решить задачу оптимизации весов с помощью нейросети.
2. В настоящий момент все объекты с пропусками в ключевых столбцах удаляются, поэтому необходимо предусмотреть процесс заполнения пропусков.
3. Предусмотреть ввод на языке, написанном не на латинице/кириллице.

## Описание модуля

Модуль состоит из нескольких частей:
1. Импорты – содержит основные пакеты, такие как pandas, scipy, sqlalchemy.
2. Общие функции – содержит функций по обработке текста, используемые различными классами;
3. Класс SqlConnector – служит для присоединения к базе SQL и скачивания оттуда матриц векторов, а также для загрузки предобученных CountVectorizer. При инициализации класса необходимо указать данные базы SQL. Методы класса:
    - .download_sparse – выводит разреженную матрицу по заданному имени;
    - .download_sparse – выводит предобученную модель по заданному имени.
5. Класс CreateSparse – служит для создания векторизованных представлений названий населенных пунктов. При инициализации класса необходимо указывать engine для связи с базой SQL и таблицу с городами, вспомогательные таблицы прописаны по умолчанию.
   Также в классе можно настроить страны, по которым будет производиться векторизация (поиск). По умолчанию это страны СНГ, Грузия, Сербия и Турция. Методы класса:
    - .add – добавляет страны в список поиска;
    - .remove – убирает страны из списка поиска;
    - .clear – полностью очищает список поиска;
    - .check – выводит страны из списка поиска;
    - .vectorize – векторизует названия городов из стран, попавших в список поиска, а также обучает выгружает векторайзеры.
7. класс Matching – служит для поиска ближайших названий к введенному запросу пользователя. Языки ввода - русский, либо английский. Близость определяется с помощью косинусного расстояния и расстояния Минковского. При вводе 
на русском языке используется русский корпус, при вводе на английском - английский. При инициализации класса необходимо указать engine для связи с базой SQL, разреженные матрицы русского и английского корпуса с дополнительными столбцами,
а также предобученные модели. Методы класса:
    - .find – выводит список словарей с полями `geonameid`, `Country`, `region`, `cosine`. Очередность вывода согласно косинусным расстояниям. Количество выводимых названий по умолчанию равно трём.

Работу с модулем можно условно разделить на несколько этапов:
1. Импорт модуля
2. Настраиваемое соединение с базой данных
3. (Опционально) Выбор стран, в которых планируется поиск, далее векторизация соответствующих корпусов.
4. Поиск

**Примеры работы с модулем:**

Соединение с базой данных.

     import geonames
     DATABASE = {'drivername': 'postgresql',
                 'username': 'postgres', 
                 'password': '112358', 
                 'host': 'localhost',
                 'port': 5432,
                 'database': 'postgres',
                 'query': {}}          
      connect = geonames.SqlConnector(DATABASE)

Загрузка разреженных матриц и предобученных моделей.

    ru_sparse = connect.download_sparse('ru_sparse')
    en_sparse = connect.download_sparse('en_sparse')
    ru_vec = connect.download_vec('ru_vector')
    en_vec = connect.download_vec('en_vector')

Поиск ближайших названий.

    module = geonames.Matching(ru_sparse=ru_sparse,
                               en_sparse=en_sparse,
                               ru_vectorizer=ru_vec,
                               en_vectorizer=en_vec,
                               engine = connect.engine)
    module.find('Владивастоук')

Изменение списка стран и векторизация.

    loader = geonames.CreateSparse(engine=connect.engine,
                                   main_table='cities500')
    loader.add(['es'])
    ru_sparse, en_sparse = loader.vectorize()
